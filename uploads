import os
from flask import Flask, request, jsonify
from tensorflow.keras.models import load_model
from PIL import Image
import numpy as np
import cv2
from werkzeug.utils import secure_filename

UPLOAD_FOLDER = "uploads"
ALLOWED_EXTENSIONS = {"png", "jpg", "jpeg"}

app = Flask(__name__)
app.config["UPLOAD_FOLDER"] = UPLOAD_FOLDER

# Ensure the folder exists
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

model = load_model("src/models/saved_model/model.h5")
IMG_SIZE = 224

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def preprocess_image(image):
    image = np.array(image)
    image = cv2.resize(image, (IMG_SIZE, IMG_SIZE))
    image = image / 255.0
    image = np.expand_dims(image, axis=0)
    return image

def diagnosis_engine(prediction, confidence):
    if prediction == "Parasitized":
        return "Parasite detected. Please consult a healthcare professional."
    else:
        return "No parasite detected."

@app.route("/predict", methods=["POST"])
def predict():
    if "image" not in request.files:
        return jsonify({"error": "No image uploaded"}), 400

    file = request.files["image"]

    if file.filename == "" or not allowed_file(file.filename):
        return jsonify({"error": "Invalid file type"}), 400

    filename = secure_filename(file.filename)
    filepath = os.path.join(app.config["UPLOAD_FOLDER"], filename)
    file.save(filepath)

    image = Image.open(filepath).convert("RGB")
    processed = preprocess_image(image)
    prob = model.predict(processed)[0][0]

    if prob > 0.5:
        pred = "Parasitized"
        conf = prob
    else:
        pred = "Uninfected"
        conf = 1 - prob

    advice = diagnosis_engine(pred, conf)

    return jsonify({"prediction": pred, "confidence": conf, "advice": advice})

if __name__ == "__main__":
    app.run(debug=True)
